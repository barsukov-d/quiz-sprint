name: Deploy Backend (Docker)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy to"
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/quiz-sprint-api

jobs:
  # ===========================================
  # Build and Push Docker Image
  # ===========================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=${{ github.event.inputs.environment }}-
            type=raw,value=${{ github.event.inputs.environment }}-latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # Deploy to Staging
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.environment == 'staging' }}
    environment:
      name: backend-staging
      url: https://staging.quiz-sprint-tma.online/health

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/staging

            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-latest

            # Create .env
            cat > .env <<EOF
            ENV=staging
            API_PORT=3001
            DB_USER=${{ secrets.STAGING_DB_USER }}
            DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
            DB_NAME=quiz_sprint_staging
            CORS_ORIGINS=https://staging.quiz-sprint-tma.online
            TELEGRAM_BOT_TOKEN=${{ secrets.STAGING_TELEGRAM_BOT_TOKEN }}
            ADMIN_API_KEY=${{ secrets.STAGING_ADMIN_API_KEY }}
            EOF

            # Update docker-compose with correct image
            cat > docker-compose.yml <<EOF
            services:
              api:
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-latest
                container_name: quiz-sprint-api-staging
                restart: unless-stopped
                ports:
                  - "3001:3000"
                env_file:
                  - .env
                environment:
                  - DB_HOST=postgres
                  - REDIS_HOST=redis
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                networks:
                  - quiz-sprint-staging

              postgres:
                image: postgres:16-alpine
                container_name: quiz-sprint-postgres-staging
                restart: unless-stopped
                environment:
                  - POSTGRES_USER=\${DB_USER}
                  - POSTGRES_PASSWORD=\${DB_PASSWORD}
                  - POSTGRES_DB=\${DB_NAME}
                volumes:
                  - postgres_staging:/var/lib/postgresql/data
                networks:
                  - quiz-sprint-staging
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U \${DB_USER} -d \${DB_NAME}"]
                  interval: 30s
                  timeout: 10s
                  retries: 5

              redis:
                image: redis:7-alpine
                container_name: quiz-sprint-redis-staging
                restart: unless-stopped
                command: redis-server --appendonly yes
                volumes:
                  - redis_staging:/data
                networks:
                  - quiz-sprint-staging
                healthcheck:
                  test: ["CMD", "redis-cli", "ping"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

            volumes:
              postgres_staging:
              redis_staging:

            networks:
              quiz-sprint-staging:
                driver: bridge
            EOF

            # Deploy
            docker compose pull
            docker compose up -d --remove-orphans

            # Wait and check
            sleep 10
            docker compose ps

      - name: Health check
        run: |
          sleep 5
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.quiz-sprint-tma.online/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Staging health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Clean duplicates and import quiz data
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/staging

            # Clean duplicate quizzes (keep oldest by title)
            echo "üßπ Cleaning duplicate quizzes..."
            docker compose exec -T postgres psql -U ${DB_USER:-quiz_user} -d ${DB_NAME:-quiz_sprint_staging} -c "
              DELETE FROM quizzes WHERE id IN (
                SELECT id FROM (
                  SELECT id, title, ROW_NUMBER() OVER (PARTITION BY title ORDER BY created_at ASC) as rn
                  FROM quizzes
                ) sub WHERE rn > 1
              );" || echo "‚ö†Ô∏è Duplicate cleanup skipped"

            # Import quiz data (with dedup - safe to run multiple times)
            echo "üì¶ Importing quiz data..."
            docker compose exec -T api /app/quiz-sprint-import -dir=/app/data/quizzes || echo "‚ö†Ô∏è Quiz import failed (non-critical)"
            echo "‚úÖ Quiz data sync completed"

  # ===========================================
  # Deploy to Production
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.environment == 'production' }}
    environment:
      name: backend-production
      url: https://quiz-sprint-tma.online/health

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/production

            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production-latest

            # Create .env if not exists
            if [ ! -f .env ]; then
              cat > .env <<EOF
            ENV=production
            API_PORT=3000
            DB_USER=${{ secrets.PROD_DB_USER }}
            DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
            DB_NAME=quiz_sprint_production
            CORS_ORIGINS=https://quiz-sprint-tma.online
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            EOF
            fi

            # Update docker-compose with correct image
            cat > docker-compose.yml <<EOF
            services:
              api:
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production-latest
                container_name: quiz-sprint-api-production
                restart: unless-stopped
                ports:
                  - "3000:3000"
                env_file:
                  - .env
                environment:
                  - DB_HOST=postgres
                  - REDIS_HOST=redis
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                networks:
                  - quiz-sprint-production

              postgres:
                image: postgres:16-alpine
                container_name: quiz-sprint-postgres-production
                restart: unless-stopped
                environment:
                  - POSTGRES_USER=\${DB_USER}
                  - POSTGRES_PASSWORD=\${DB_PASSWORD}
                  - POSTGRES_DB=\${DB_NAME}
                volumes:
                  - postgres_production:/var/lib/postgresql/data
                networks:
                  - quiz-sprint-production
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U \${DB_USER} -d \${DB_NAME}"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              redis:
                image: redis:7-alpine
                container_name: quiz-sprint-redis-production
                restart: unless-stopped
                command: redis-server --appendonly yes
                volumes:
                  - redis_production:/data
                networks:
                  - quiz-sprint-production
                healthcheck:
                  test: ["CMD", "redis-cli", "ping"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

            volumes:
              postgres_production:
              redis_production:

            networks:
              quiz-sprint-production:
                driver: bridge
            EOF

            # Deploy
            docker compose pull
            docker compose up -d --remove-orphans

            # Wait and check
            sleep 10
            docker compose ps

      - name: Health check
        run: |
          sleep 5
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://quiz-sprint-tma.online/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Production health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Clean duplicates and import quiz data
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/production

            # Clean duplicate quizzes (keep oldest by title)
            echo "üßπ Cleaning duplicate quizzes..."
            docker compose exec -T postgres psql -U ${DB_USER:-quiz_user} -d ${DB_NAME:-quiz_sprint_production} -c "
              DELETE FROM quizzes WHERE id IN (
                SELECT id FROM (
                  SELECT id, title, ROW_NUMBER() OVER (PARTITION BY title ORDER BY created_at ASC) as rn
                  FROM quizzes
                ) sub WHERE rn > 1
              );" || echo "‚ö†Ô∏è Duplicate cleanup skipped"

            # Import quiz data (with dedup - safe to run multiple times)
            echo "üì¶ Importing quiz data..."
            docker compose exec -T api /app/quiz-sprint-import -dir=/app/data/quizzes || echo "‚ö†Ô∏è Quiz import failed (non-critical)"
            echo "‚úÖ Quiz data sync completed"

  # ===========================================
  # Notify
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')

    steps:
      - name: Send Telegram notification
        env:
          STAGING_RESULT: ${{ needs.deploy-staging.result }}
          PROD_RESULT: ${{ needs.deploy-production.result }}
          ENV: ${{ github.event.inputs.environment }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ "$ENV" = "staging" ]; then
            STATUS="$STAGING_RESULT"
            URL="https://staging.quiz-sprint-tma.online/health"
          else
            STATUS="$PROD_RESULT"
            URL="https://quiz-sprint-tma.online/health"
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            TITLE="Docker deployment successful!"
          else
            EMOJI="‚ùå"
            TITLE="Docker deployment failed!"
          fi

          MESSAGE="${EMOJI} <b>${TITLE}</b>%0A%0Aüåç Environment: ${ENV}%0Aüê≥ Docker image deployed%0Aüåê URL: ${URL}%0Aüë§ By: ${ACTOR}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || echo "Telegram notification failed"
