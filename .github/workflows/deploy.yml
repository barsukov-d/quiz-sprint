name: Deploy TMA

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy to"
        required: true
        type: choice
        options:
          - staging
          - production
      artifact:
        description: "Artifact name (leave empty for latest build)"
        required: false
        type: string

jobs:
  # ===========================================
  # Find and download artifact
  # ===========================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.find.outputs.artifact_name }}

    steps:
      - name: Find artifact
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.inputs.artifact }}" ]; then
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
            echo "artifact_name=${{ github.event.inputs.artifact }}" >> $GITHUB_OUTPUT
            echo "Using specified artifact: ${{ github.event.inputs.artifact }}"
          else
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
            LATEST=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq '.artifacts | map(select(.name | startswith("tma-build-"))) | sort_by(.created_at) | reverse | .[0].name')

            if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
              echo "::error::No build artifacts found. Run 'Build TMA' workflow first."
              exit 1
            fi

            echo "artifact_name=$LATEST" >> $GITHUB_OUTPUT
            echo "Using latest artifact: $LATEST"
          fi

      - name: Download artifact from Build workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTIFACT_NAME="${{ steps.find.outputs.artifact_name }}"
          echo "Downloading artifact: $ARTIFACT_NAME"

          # –ü–æ–ª—É—á–∞–µ–º ID –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (–±–µ—Ä—ë–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ)
          ARTIFACT_ID=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq ".artifacts | map(select(.name == \"$ARTIFACT_NAME\")) | sort_by(.created_at) | reverse | .[0].id")

          if [ -z "$ARTIFACT_ID" ]; then
            echo "::error::Artifact not found: $ARTIFACT_NAME"
            exit 1
          fi

          echo "Artifact ID: $ARTIFACT_ID"

          # –°–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
          gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip > artifact.zip
          mkdir -p dist
          unzip artifact.zip -d dist/
          echo "Artifact contents:"
          ls -la dist/

      - name: Upload for next jobs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-artifact
          path: dist/
          retention-days: 1

  # ===========================================
  # Deploy to Staging
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.environment == 'staging' }}
    environment:
      name: staging
      url: https://staging.quiz-sprint-tma.online

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-artifact
          path: dist/

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "dist/*"
          target: "/var/www/tma/staging/"
          strip_components: 1
          rm: true

      - name: Set permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            chown -R www-data:www-data /var/www/tma/staging

      - name: Health check
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.quiz-sprint-tma.online)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Staging health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

  # ===========================================
  # Deploy to Production
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.environment == 'production' }}
    environment:
      name: production
      url: https://quiz-sprint-tma.online

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-artifact
          path: dist/

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "dist/*"
          target: "/var/www/tma/production/"
          strip_components: 1
          rm: true

      - name: Set permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            chown -R www-data:www-data /var/www/tma/production

      - name: Health check
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://quiz-sprint-tma.online)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Production health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

  # ===========================================
  # Notify
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')

    steps:
      - name: Send Telegram notification
        env:
          STAGING_RESULT: ${{ needs.deploy-staging.result }}
          PROD_RESULT: ${{ needs.deploy-production.result }}
          ENV: ${{ github.event.inputs.environment }}
          ARTIFACT: ${{ needs.prepare.outputs.artifact_name }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ "$ENV" = "staging" ]; then
            STATUS="$STAGING_RESULT"
            URL="https://staging.quiz-sprint-tma.online"
          else
            STATUS="$PROD_RESULT"
            URL="https://quiz-sprint-tma.online"
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            TITLE="Deployment successful!"
          else
            EMOJI="‚ùå"
            TITLE="Deployment failed!"
          fi

          MESSAGE="${EMOJI} <b>${TITLE}</b>%0A%0Aüåç Environment: ${ENV}%0Aüåê URL: ${URL}%0Aüì¶ Artifact: ${ARTIFACT}%0Aüë§ By: ${ACTOR}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || echo "Telegram notification failed"
