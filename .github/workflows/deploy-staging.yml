name: Deploy to Staging

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: ./tma
        run: pnpm install --frozen-lockfile

      - name: Type check
        working-directory: ./tma
        run: pnpm type-check

      - name: Lint
        working-directory: ./tma
        run: pnpm lint

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: ./tma
        run: pnpm install --frozen-lockfile

      - name: Build for staging
        working-directory: ./tma
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create directory on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p /var/www/tma/staging"

      - name: Deploy to VPS
        run: |
          scp -r tma/dist/* ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/tma/staging/

      - name: Set correct permissions
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "chown -R www-data:www-data /var/www/tma/staging"

      - name: Health check
        run: |
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 5

          echo "üîç Performing health check..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.quiz-sprint-tma.online)

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "304" ]; then
            echo "‚úÖ Health check passed (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Health check warning (HTTP $RESPONSE)"
            echo "This might be OK if this is the first deployment"
          fi

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()

    steps:
      - name: Send Telegram notification
        env:
          STATUS: ${{ needs.build-and-deploy.result }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          if [ "$STATUS" = "success" ]; then
            MESSAGE="‚úÖ <b>Staging deployment successful!</b>%0A%0Aüåê URL: https://staging.quiz-sprint-tma.online%0Aüë§ By: $ACTOR%0Aüìù Commit: ${COMMIT_SHA:0:7}%0Aüí¨ Message: ${COMMIT_MESSAGE:0:100}"
          else
            MESSAGE="‚ùå <b>Staging deployment failed!</b>%0A%0Aüë§ By: $ACTOR%0Aüìù Commit: ${COMMIT_SHA:0:7}%0Aüí¨ Message: ${COMMIT_MESSAGE:0:100}"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || echo "‚ö†Ô∏è Telegram notification failed (check TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets)"
