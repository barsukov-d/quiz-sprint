name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      artifact:
        description: 'Artifact name (leave empty for latest build)'
        required: false
        type: string

jobs:
  # ===========================================
  # Find and download artifact
  # ===========================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.find.outputs.artifact_name }}

    steps:
      - name: Find artifact
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.inputs.artifact }}" ]; then
            echo "artifact_name=${{ github.event.inputs.artifact }}" >> $GITHUB_OUTPUT
            echo "Using specified artifact: ${{ github.event.inputs.artifact }}"
          else
            LATEST=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq '.artifacts | map(select(.name | startswith("backend-build-"))) | sort_by(.created_at) | reverse | .[0].name')

            if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
              echo "::error::No build artifacts found. Run 'Build Backend' workflow first."
              exit 1
            fi

            echo "artifact_name=$LATEST" >> $GITHUB_OUTPUT
            echo "Using latest artifact: $LATEST"
          fi

      - name: Download artifact from Build workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTIFACT_NAME="${{ steps.find.outputs.artifact_name }}"
          echo "Downloading artifact: $ARTIFACT_NAME"

          ARTIFACT_ID=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id")

          if [ -z "$ARTIFACT_ID" ]; then
            echo "::error::Artifact not found: $ARTIFACT_NAME"
            exit 1
          fi

          echo "Artifact ID: $ARTIFACT_ID"

          gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip > artifact.zip
          mkdir -p backend/
          unzip artifact.zip -d backend/
          chmod +x backend/quiz-sprint-api
          ls -la backend/

      - name: Upload for next jobs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-backend-artifact
          path: backend/quiz-sprint-api
          retention-days: 1

  # ===========================================
  # Deploy to Staging
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.environment == 'staging' }}
    environment:
      name: backend-staging
      url: https://staging.quiz-sprint-tma.online/api/health

    steps:
      - name: Checkout (for .env template)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            backend/.env.example

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-backend-artifact
          path: backend/

      - name: Deploy binary to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/quiz-sprint-api"
          target: "/opt/quiz-sprint/staging/"
          strip_components: 1

      - name: Create .env and restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/staging

            # Create .env if not exists
            if [ ! -f .env ]; then
              cat > .env <<EOF
            PORT=3001
            ENV=staging
            DB_HOST=localhost
            DB_PORT=5432
            DB_USER=${{ secrets.STAGING_DB_USER }}
            DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
            DB_NAME=quiz_sprint_staging
            DB_SSLMODE=disable
            CORS_ORIGINS=https://staging.quiz-sprint-tma.online
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            EOF
            fi

            # Set permissions
            chmod +x quiz-sprint-api
            chown quiz-sprint:quiz-sprint quiz-sprint-api .env

            # Restart service
            systemctl restart quiz-sprint-api-staging

            # Wait for service to start
            sleep 2

            # Check service status
            systemctl status quiz-sprint-api-staging

      - name: Health check
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.quiz-sprint-tma.online/api/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Staging health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

  # ===========================================
  # Deploy to Production
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.environment == 'production' }}
    environment:
      name: backend-production
      url: https://quiz-sprint-tma.online/api/health

    steps:
      - name: Checkout (for .env template)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            backend/.env.example

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-backend-artifact
          path: backend/

      - name: Deploy binary to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/quiz-sprint-api"
          target: "/opt/quiz-sprint/production/"
          strip_components: 1

      - name: Create .env and restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/quiz-sprint/production

            # Create .env if not exists
            if [ ! -f .env ]; then
              cat > .env <<EOF
            PORT=3000
            ENV=production
            DB_HOST=localhost
            DB_PORT=5432
            DB_USER=${{ secrets.PROD_DB_USER }}
            DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
            DB_NAME=quiz_sprint_production
            DB_SSLMODE=disable
            CORS_ORIGINS=https://quiz-sprint-tma.online
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            EOF
            fi

            # Set permissions
            chmod +x quiz-sprint-api
            chown quiz-sprint:quiz-sprint quiz-sprint-api .env

            # Restart service
            systemctl restart quiz-sprint-api-production

            # Wait for service to start
            sleep 2

            # Check service status
            systemctl status quiz-sprint-api-production

      - name: Health check
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://quiz-sprint-tma.online/api/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Production health check passed"
          else
            echo "::error::Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

  # ===========================================
  # Notify
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')

    steps:
      - name: Send Telegram notification
        env:
          STAGING_RESULT: ${{ needs.deploy-staging.result }}
          PROD_RESULT: ${{ needs.deploy-production.result }}
          ENV: ${{ github.event.inputs.environment }}
          ARTIFACT: ${{ needs.prepare.outputs.artifact_name }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ "$ENV" = "staging" ]; then
            STATUS="$STAGING_RESULT"
            URL="https://staging.quiz-sprint-tma.online/api/health"
          else
            STATUS="$PROD_RESULT"
            URL="https://quiz-sprint-tma.online/api/health"
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            TITLE="Backend deployment successful!"
          else
            EMOJI="âŒ"
            TITLE="Backend deployment failed!"
          fi

          MESSAGE="${EMOJI} <b>${TITLE}</b>%0A%0AğŸŒ Environment: ${ENV}%0AğŸŒ URL: ${URL}%0AğŸ“¦ Artifact: ${ARTIFACT}%0AğŸ‘¤ By: ${ACTOR}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || echo "Telegram notification failed"
