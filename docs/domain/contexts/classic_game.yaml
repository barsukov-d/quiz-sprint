bounded_context:
  name: "Classic Mode"
  type: "Core Domain"
  description: "Handles the classic solo quiz-taking experience with enhanced game juice mechanics, streak multipliers, and ghost comparison for personal mastery."
  business_rules:
    - "A game is started by a single user for a specific quiz."
    - "The game ends when all questions in the quiz have been answered."
    - "Scoring Formula: Score = (BasePoints + TimeBonus) * Multiplier."
    - "BasePoints: Fixed value per question."
    - "TimeBonus: Linearly decreases from maximum to zero over the question time limit."
    - "Streak Multiplier: x1.0 (0-2 correct), x1.5 (3-5 correct 'On Fire'), x2.0 (6+ correct 'Godlike')."
    - "Any incorrect answer or timeout immediately resets CurrentStreak to 0 and Multiplier to x1.0."
    - "Visual states transition based on streak: Normal (< 3), Heat (>= 3), Fire (>= 6)."
    - "Personal Best: Only successful games (PassingScore reached) update the user's PersonalBest for that quiz."
    - "Ghost Comparison: During gameplay, system calculates score difference vs PersonalBest at the same question index."
    - "MaxStreak tracks the highest streak achieved during the current game session."
    - "Upon completion, the final score is published to the Leaderboard for ranking."

value_objects:
  - name: "GameStatus"
    type: "string"
    description: "Represents the lifecycle of a game."
    allowed_values: ["InProgress", "Finished"]
    invariants:
      - "Status can only transition from InProgress to Finished."

  - name: "VisualState"
    type: "string"
    description: "Represents the visual intensity state of the game UI for game juice feedback."
    allowed_values: ["Normal", "Heat", "Fire"]
    invariants:
      - "Normal: Streak < 3."
      - "Heat: Streak >= 3 and < 6."
      - "Fire: Streak >= 6."

aggregates:
  - name: "ClassicGame"
    description: "Represents a single classic game session with enhanced scoring mechanics, visual feedback system, and ghost comparison for personal mastery."
    state:
      - name: "ID"
        type: "uuid.UUID"
      - name: "PlayerID"
        type: "uuid.UUID"
      - name: "QuizID"
        type: "uuid.UUID"
      - name: "Status"
        type: "GameStatus"
      - name: "Session"
        type: "kernel.QuizGameplaySession"
        description: "Underlying gameplay session handling questions and answers."
      - name: "TotalScore"
        type: "kernel.Points"
        description: "Accumulated score for the game."
      - name: "CurrentStreak"
        type: "int"
        description: "Number of consecutive correct answers in current game."
      - name: "MaxStreak"
        type: "int"
        description: "Maximum streak achieved during this game session."
      - name: "CurrentMultiplier"
        type: "kernel.Multiplier"
        description: "Current score multiplier based on streak."
      - name: "PersonalBestScore"
        type: "*int"
        description: "Player's PersonalBest score for this quiz (nil if no previous record)."
      - name: "GhostComparison"
        type: "int"
        description: "Score difference relative to PersonalBest at the same question index."

    methods:
      - name: "NewClassicGame"
        params:
          - { name: "playerID", type: "uuid.UUID" }
          - { name: "quiz", type: "catalog.Quiz" }
          - { name: "personalBest", type: "*PersonalBest" }
        returns:
          - { type: "*ClassicGame" }
          - { type: "error" }
        logic: |
          1. Create new QuizGameplaySession from quiz.
          2. Initialize CurrentStreak = 0, MaxStreak = 0, CurrentMultiplier = 1.0, TotalScore = 0.
          3. If personalBest exists, store PersonalBestScore for ghost comparison.
          4. Set Status = InProgress.
        description: "Creates a new classic game session."

      - name: "SubmitAnswer"
        params:
          - { name: "questionID", type: "uuid.UUID" }
          - { name: "answerID", type: "uuid.UUID" }
          - { name: "timeTaken", type: "time.Duration" }
        returns:
          - { type: "error" }
        logic: |
          1. Delegate to Session.AnswerQuestion(questionID, answerID).
          2. If answer is correct:
             a. Increment CurrentStreak. Update MaxStreak.
             b. Update CurrentMultiplier (1.0, 1.5, or 2.0).
             c. Calculate TimeBonus using kernel logic.
             d. Calculate QuestionScore = kernel.ScoringPolicy.CalculateQuestionScore(BasePoints, TimeBonus, CurrentMultiplier).
             e. Add QuestionScore to TotalScore.
             f. Update GhostComparison if PersonalBestScore exists.
          3. If incorrect:
             a. Reset CurrentStreak = 0, CurrentMultiplier = 1.0.
          4. If last question, Finish().
        description: "Submits an answer and updates game state using shared scoring policy."

      - name: "Finish"
        returns:
          - { type: "error" }
        logic: |
          1. Mark Status = Finished.
          2. Determine if IsNewPersonalBest.
          3. Publish ClassicGameFinished event.
        description: "Finalizes the game."

  - name: "PersonalBest"
    description: "Tracks a player's best performance for a specific quiz."
    state:
      - name: "PlayerID"
        type: "uuid.UUID"
      - name: "QuizID"
        type: "uuid.UUID"
      - name: "BestScore"
        type: "int"
      - name: "MaxStreak"
        type: "int"
      - name: "AchievedAt"
        type: "int64"
      - name: "ScoreByQuestion"
        type: "[]int"

    methods:
      - name: "UpdateIfBetter"
        params:
          - { name: "game", type: "*ClassicGame" }
        returns:
          - { type: "bool" }
        description: "Updates the PersonalBest if the provided game achieved a higher score."

domain_events:
  - name: "ClassicGameStarted"
    attributes:
      - { name: "GameID", type: "uuid.UUID" }
      - { name: "PlayerID", type: "uuid.UUID" }
      - { name: "QuizID", type: "uuid.UUID" }
      - { name: "StartedAt", type: "int64" }

  - name: "ClassicGameFinished"
    attributes:
      - { name: "GameID", type: "uuid.UUID" }
      - { name: "PlayerID", type: "uuid.UUID" }
      - { name: "FinalScore", type: "int" }
      - { name: "IsNewPersonalBest", type: "bool" }
      - { name: "FinishedAt", type: "int64" }

repositories:
  - name: "ClassicGameRepository"
    methods:
      - name: "FindByID"
        params: [{ name: "id", type: "uuid.UUID" }]
        returns: ["*ClassicGame", "error"]
      - name: "Save"
        params: [{ name: "game", type: "*ClassicGame" }]
        returns: ["error"]

  - name: "PersonalBestRepository"
    methods:
      - name: "FindByPlayerAndQuiz"
        params: [{ name: "playerID", type: "uuid.UUID" }, { name: "quizID", type: "uuid.UUID" }]
        returns: ["*PersonalBest", "error"]
      - name: "Save"
        params: [{ name: "personalBest", type: "*PersonalBest" }]
        returns: ["error"]

dependencies:
  - context: "Shared Kernel"
    reason: "Uses QuizGameplaySession and shared scoring value objects (Points, Multiplier, ScoringPolicy)."
  - context: "Quiz Catalog"
    reason: "Fetches quiz content."
  - context: "Identity"
    reason: "References player identity."
  - context: "Leaderboard"
    reason: "Publishes final scores."
