bounded_context:
  name: "Daily Survival Marathon"
  type: "Core Domain"
  description: "A competitive daily mode where players progress through increasingly difficult quiz stages with limited lives, power-ups, and survival-based scoring."
  business_rules:
    - "Players can attempt the Daily Marathon only once per 24-hour UTC period."
    - "Every session starts with exactly 3 lives (❤️ ❤️ ❤️)."
    - "Each incorrect answer or timeout loses 1 life."
    - "Session ends immediately (permadeath) when lives reach 0."
    - "To advance to next stage, player must complete current stage with at least 1 life remaining."
    - "Power-ups are earned upon stage completion or 5-answer combo streak."
    - "Power-ups are session-specific and do not carry over to next day."
    - "Stages have progressive difficulty: more questions, shorter timers, harder topics."
    - "Scoring includes base points, speed bonus, stage completion bonus, and survival bonus."
    - "Daily Marathon content (stage quizzes) is the same for all players within a UTC day."

value_objects:
  - name: "Lives"
    type: "int"
    description: "Current number of lives remaining in the session."
    invariants:
      - "Must be between 0 and 3."
      - "Decrements by 1 for each incorrect answer or timeout."
      - "Cannot be restored during gameplay."
      - "Session ends when reaches 0."

  - name: "StageNumber"
    type: "int"
    description: "Current stage number in the marathon progression."
    invariants:
      - "Starts at 1."
      - "Increments by 1 upon successful stage completion."
      - "Cannot skip stages."

  - name: "PowerUpType"
    type: "string"
    description: "Types of power-ups available in the marathon."
    allowed_values: ["FiftyFifty", "TimeExtension", "Skip"]
    invariants:
      - "FiftyFifty: Removes 2 incorrect answer options."
      - "TimeExtension: Adds +20 seconds to current question timer."
      - "Skip: Skip current question without losing life (no points)."

  - name: "PowerUp"
    type: "struct"
    description: "A power-up item in player's inventory."
    fields:
      - name: "Type"
        type: "PowerUpType"
      - name: "Used"
        type: "bool"
    invariants:
      - "Once used, cannot be used again."
      - "Can only be used during active gameplay."

  - name: "SurvivalBonus"
    type: "kernel.Points"
    description: "Bonus points awarded for each remaining life at stage end."
    invariants:
      - "Calculated as: RemainingLives * BonusPerLife."
      - "Applied at stage completion."

aggregates:
  - name: "DailySurvivalSession"
    description: "Represents a player's active Daily Marathon session."
    state:
      - name: "ID"
        type: "uuid.UUID"
      - name: "PlayerID"
        type: "uuid.UUID"
      - name: "MarathonDate"
        type: "int64"
        description: "Unix timestamp of the UTC day."
      - name: "CurrentStage"
        type: "int"
      - name: "Lives"
        type: "int"
      - name: "PowerUps"
        type: "[]PowerUp"
      - name: "TotalScore"
        type: "kernel.Points"
      - name: "StagesCleared"
        type: "int"
      - name: "CurrentComboStreak"
        type: "int"
      - name: "StartedAt"
        type: "int64"
      - name: "CompletedAt"
        type: "int64"
      - name: "Status"
        type: "string"

    methods:
      - name: "NewDailySurvivalSession"
        params:
          - { name: "playerID", type: "uuid.UUID" }
          - { name: "marathonDate", type: "int64" }
        returns:
          - { type: "*DailySurvivalSession" }
        description: "Creates a new marathon session."

      - name: "LoseLife"
        returns:
          - { type: "error" }
        logic: |
          1. Decrement Lives.
          2. Reset CurrentComboStreak.
          3. If Lives == 0, end session as Failed.
        description: "Records a life lost."

      - name: "RecordCorrectAnswer"
        params:
          - { name: "points", type: "kernel.Points" }
        returns:
          - { type: "error" }
        logic: |
          1. Add points to TotalScore.
          2. Increment CurrentComboStreak.
          3. If streak == 5, grant random PowerUp and reset streak.
        description: "Records a correct answer and checks for combo bonus."

      - name: "CompleteStage"
        returns:
          - { type: "error" }
        logic: |
          1. Add SurvivalBonus to TotalScore.
          2. Grant random PowerUp.
          3. Advance stage.
        description: "Finalizes current stage."

      - name: "UsePowerUp"
        params:
          - { name: "powerUpType", type: "PowerUpType" }
        returns:
          - { type: "error" }
        description: "Consumes a power-up."

  - name: "DailyMarathon"
    description: "Represents the daily marathon configuration for a specific date."
    state:
      - name: "ID"
        type: "uuid.UUID"
      - name: "Date"
        type: "int64"
      - name: "Stages"
        type: "[]MarathonStage"
      - name: "CreatedAt"
        type: "int64"

  - name: "MarathonStage"
    description: "Configuration for a single stage."
    state:
      - name: "StageNumber"
        type: "int"
      - name: "QuizID"
        type: "uuid.UUID"
      - name: "TimePerQuestion"
        type: "int"
      - name: "Difficulty"
        type: "string"
      - name: "CompletionBonus"
        type: "kernel.Points"

domain_events:
  - name: "DailyMarathonStarted"
    attributes:
      - { name: "SessionID", type: "uuid.UUID" }
      - { name: "PlayerID", type: "uuid.UUID" }
      - { name: "StartedAt", type: "int64" }

  - name: "LifeLost"
    attributes:
      - { name: "SessionID", type: "uuid.UUID" }
      - { name: "RemainingLives", type: "int" }
      - { name: "LostAt", type: "int64" }

  - name: "StageCompleted"
    attributes:
      - { name: "SessionID", type: "uuid.UUID" }
      - { name: "StageNumber", type: "int" }
      - { name: "TotalScore", type: "kernel.Points" }
      - { name: "CompletedAt", type: "int64" }

repositories:
  - name: "DailyMarathonRepository"
    methods:
      - name: "FindByDate"
        params: [{ name: "date", type: "int64" }]
        returns: ["*DailyMarathon", "error"]

  - name: "DailySurvivalSessionRepository"
    methods:
      - name: "FindByID"
        params: [{ name: "id", type: "uuid.UUID" }]
        returns: ["*DailySurvivalSession", "error"]
      - name: "Save"
        params: [{ name: "session", type: "*DailySurvivalSession" }]
        returns: ["error"]

dependencies:
  - context: "Shared Kernel"
    reason: "Uses shared points and base session types."
  - context: "Quiz Catalog"
    reason: "Fetches quiz content for stages."
  - context: "Identity"
    reason: "References player identity."
