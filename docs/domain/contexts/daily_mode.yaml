bounded_context:
  name: "Daily Mode"
  type: "Core Domain"
  description: "Handles daily quiz challenges with streak tracking and bonus rewards to encourage daily engagement."
  business_rules:
    - "All users receive the same daily quiz content within a 24-hour UTC period."
    - "Daily quiz can be completed once per day for bonus rewards."
    - "Daily Streak tracks consecutive days of completion (UTC-based calendar days)."
    - "Daily Streak resets to 0 if user misses a calendar day (more than 48 hours gap)."
    - "First daily quiz completion in a calendar day applies x1.5 multiplier to final score."
    - "Daily Streak increments by 1 if completed on a new calendar day within 48 hours of last completion."
    - "Daily Streak resets to 1 if more than 48 hours have passed since last completion."

value_objects:
  - name: "DailyStreak"
    type: "int"
    description: "Consecutive days the user has completed the daily quiz."
    invariants:
      - "Must be non-negative."
      - "Resets to 0 if a calendar day is skipped."
      - "Increments only once per UTC calendar day."

  - name: "DailyBonus"
    type: "float64"
    description: "Multiplier applied to first daily quiz completion."
    allowed_values: [1.5]
    invariants:
      - "Applied only once per UTC calendar day."
      - "Applied to final score after all other calculations."

aggregates:
  - name: "DailyProgress"
    description: "Tracks a player's daily quiz participation and streak."
    state:
      - name: "PlayerID"
        type: "uuid.UUID"
      - name: "DailyStreak"
        type: "int"
        description: "Current consecutive days streak."
      - name: "LastDailyCompletedAt"
        type: "int64"
        description: "Unix timestamp of last daily quiz completion."
      - name: "LastCompletedDailyQuizID"
        type: "uuid.UUID"
        description: "ID of the last daily quiz completed."

    methods:
      - name: "NewDailyProgress"
        params:
          - { name: "playerID", type: "uuid.UUID" }
        returns:
          - { type: "*DailyProgress" }
        description: "Creates a new daily progress tracker for a player."

      - name: "CompleteDailyQuiz"
        params:
          - { name: "quizID", type: "uuid.UUID" }
          - { name: "completedAt", type: "int64" }
        returns:
          - { type: "error" }
        logic: |
          1. Check if this is the same quiz as LastCompletedDailyQuizID.
          2. If yes, return error (already completed today).
          3. Calculate hours since LastDailyCompletedAt.
          4. If < 24 hours and same UTC day: return error (already completed today).
          5. If >= 24 hours and < 48 hours and new UTC day:
             - Increment DailyStreak by 1.
          6. If >= 48 hours:
             - Reset DailyStreak to 1.
          7. Update LastDailyCompletedAt and LastCompletedDailyQuizID.
          8. Publish DailyQuizCompleted event.
        description: "Records completion of daily quiz and updates streak."

      - name: "CanPlayDailyQuiz"
        params:
          - { name: "currentQuizID", type: "uuid.UUID" }
          - { name: "currentTime", type: "int64" }
        returns:
          - { type: "bool" }
        logic: |
          1. If LastCompletedDailyQuizID != currentQuizID: return true.
          2. Check if LastDailyCompletedAt is in a previous UTC day: return true.
          3. Otherwise: return false.
        description: "Checks if player is eligible to play today's daily quiz."

      - name: "GetCurrentStreak"
        returns:
          - { type: "int" }
        description: "Returns the current daily streak count."

  - name: "DailyQuiz"
    description: "Represents the daily quiz available for a specific date."
    state:
      - name: "ID"
        type: "uuid.UUID"
      - name: "QuizID"
        type: "uuid.UUID"
        description: "Reference to the actual quiz in the catalog."
      - name: "AvailableDate"
        type: "int64"
        description: "Unix timestamp for the UTC day this quiz is active."
      - name: "CreatedAt"
        type: "int64"

    methods:
      - name: "NewDailyQuiz"
        params:
          - { name: "quizID", type: "uuid.UUID" }
          - { name: "availableDate", type: "int64" }
        returns:
          - { type: "*DailyQuiz" }
          - { type: "error" }
        description: "Creates a new daily quiz assignment for a specific date."

      - name: "IsActiveToday"
        params:
          - { name: "currentTime", type: "int64" }
        returns:
          - { type: "bool" }
        description: "Checks if this daily quiz is active for the current UTC day."

domain_events:
  - name: "DailyQuizCreated"
    description: "Published when a new daily quiz is scheduled."
    attributes:
      - { name: "DailyQuizID", type: "uuid.UUID" }
      - { name: "QuizID", type: "uuid.UUID" }
      - { name: "AvailableDate", type: "int64" }
      - { name: "CreatedAt", type: "time.Time" }

  - name: "DailyQuizCompleted"
    description: "Published when a player completes their daily quiz."
    attributes:
      - { name: "PlayerID", type: "uuid.UUID" }
      - { name: "DailyQuizID", type: "uuid.UUID" }
      - { name: "QuizID", type: "uuid.UUID" }
      - { name: "NewDailyStreak", type: "int" }
      - { name: "BonusApplied", type: "bool" }
      - { name: "CompletedAt", type: "time.Time" }

  - name: "DailyStreakBroken"
    description: "Published when a player's daily streak is reset due to missing a day."
    attributes:
      - { name: "PlayerID", type: "uuid.UUID" }
      - { name: "PreviousStreak", type: "int" }
      - { name: "BrokenAt", type: "time.Time" }

application_services:
  - name: "DailyModeService"
    description: "Orchestrates daily quiz operations."
    methods:
      - name: "GetTodaysDailyQuiz"
        params:
          - { name: "ctx", type: "context.Context" }
        returns:
          - { type: "*DailyQuiz" }
          - { type: "error" }
        description: "Retrieves the daily quiz for the current UTC day."

      - name: "StartDailyGame"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "playerID", type: "uuid.UUID" }
        returns:
          - { name: "gameID", type: "uuid.UUID" }
          - { type: "error" }
        logic: |
          1. Get today's DailyQuiz.
          2. Get player's DailyProgress.
          3. Check CanPlayDailyQuiz.
          4. If not eligible, return error.
          5. Create ClassicGame with IsDailyQuiz=true.
          6. Return game ID.
        description: "Starts a daily quiz game session for the player."

      - name: "CompleteDailyGame"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "gameID", type: "uuid.UUID" }
          - { name: "playerID", type: "uuid.UUID" }
          - { name: "finalScore", type: "int" }
        returns:
          - { type: "error" }
        logic: |
          1. Get ClassicGame by ID.
          2. Verify it's a daily quiz game.
          3. Apply x1.5 bonus to finalScore.
          4. Update DailyProgress.CompleteDailyQuiz.
          5. Save updated score and progress.
          6. Publish DailyQuizCompleted event.
        description: "Finalizes a daily quiz game with bonus application and streak tracking."

      - name: "GetPlayerDailyProgress"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "playerID", type: "uuid.UUID" }
        returns:
          - { type: "*DailyProgress" }
          - { type: "error" }
        description: "Retrieves the player's daily quiz progress and streak information."

      - name: "CreateDailyQuiz"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "quizID", type: "uuid.UUID" }
          - { name: "availableDate", type: "int64" }
        returns:
          - { type: "*DailyQuiz" }
          - { type: "error" }
        description: "Admin function to schedule a quiz as the daily quiz for a specific date."

repositories:
  - name: "DailyProgressRepository"
    description: "Persistence interface for DailyProgress aggregate."
    methods:
      - name: "FindByPlayerID"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "playerID", type: "uuid.UUID" }
        returns:
          - { type: "*DailyProgress" }
          - { type: "error" }

      - name: "Save"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "progress", type: "*DailyProgress" }
        returns:
          - { type: "error" }

  - name: "DailyQuizRepository"
    description: "Persistence interface for DailyQuiz aggregate."
    methods:
      - name: "FindByDate"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "date", type: "int64" }
        returns:
          - { type: "*DailyQuiz" }
          - { type: "error" }

      - name: "FindByID"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "id", type: "uuid.UUID" }
        returns:
          - { type: "*DailyQuiz" }
          - { type: "error" }

      - name: "Save"
        params:
          - { name: "ctx", type: "context.Context" }
          - { name: "dailyQuiz", type: "*DailyQuiz" }
        returns:
          - { type: "error" }

dependencies:
  - context: "Classic Mode"
    reason: "Daily quiz games use ClassicGame aggregate with IsDailyQuiz flag."
  - context: "Quiz Catalog"
    reason: "References actual quiz content."
  - context: "Identity"
    reason: "Tracks progress per player."
